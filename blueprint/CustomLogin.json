{"status":{},"contains_secrets":false,"product_version":"3.1.0","spec":{"description":"Demo app blueprint","resources":{"client_attrs":{"None":{"Profile":{"AHV":{"Action":{},"dsl_name":"AHV"}},"Package":{"centos7":{"Action":{},"dsl_name":"centos7"},"NginxPackage":{"Action":{},"dsl_name":"NginxPackage"}},"Substrate":{"NginxSubstrace":{"Action":{},"AhvVm":{"CentosAhvVM":{"dsl_name":"CentosAhvVM"}},"dsl_name":"NginxSubstrace"}},"Service":{"Nginx":{"Action":{},"dsl_name":"Nginx"}},"Deployment":{"NginxDeployment":{"Action":{},"dsl_name":"NginxDeployment"}}}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_Nginx_action_create","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_Nginx_action_create","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_Nginx_action_create"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_Nginx_action_delete","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_Nginx_action_delete","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_Nginx_action_delete"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_Nginx_action_start","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_Nginx_action_start","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_Nginx_action_start"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_Nginx_action_stop","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_Nginx_action_stop","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_Nginx_action_stop"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_Nginx_action_restart","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_Nginx_action_restart","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_Nginx_action_restart"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Service_Nginx_action_soft_delete","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Service_Nginx_action_soft_delete","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Service_Nginx_action_soft_delete"},"variable_list":[]},"name":"action_soft_delete"}],"depends_on_list":[],"name":"Nginx","port_list":[],"tier":"","variable_list":[],"description":"CentOS based image"}],"substrate_definition_list":[{"description":"CentOS substrate","action_list":[],"type":"AHV_VM","name":"NginxSubstrace","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":true},"os_type":"Linux","create_spec":{"name":"CentosAhvVM","resources":{"nic_list":[{"nic_type":"DIRECT_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"Net-01","uuid":"f03809a2-2b03-4386-b080-fa38fa9a9b74"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n- name: centos\n  ssh-authorized-keys:\n  - '@@{CENTOS_CRED.public_key}@@'\n  sudo:\n  - ALL=(ALL) NOPASSWD:ALL\n"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"acb2f79f-9c13-4f1e-a377-70bfb8f65a12","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"centos7","uuid":"9397361f-2842-41c6-be9f-1c6b1c63b8dd"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS_CRED"}],"package_definition_list":[{"description":"DemoApp package","action_list":[],"type":"CUSTOM","service_local_reference_list":[{"kind":"app_service","name":"Nginx"}],"name":"NginxPackage","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Prepare Centos"},{"kind":"app_task","name":"Install docker"},{"kind":"app_task","name":"Install custom login app"}],"name":"NginxPackage___install___dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Prepare Centos"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install docker"}},{"from_task_reference":{"kind":"app_task","name":"Install docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install custom login app"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Prepare Centos","attrs":{"script":"#!\/bin\/bash\nset -ex\n\nsudo yum update --quiet -y\nsudo yum --quiet -y install epel-release \\\n                            yum-utils \\\n                            git \\\n                            curl \\\n                            wget \\\n                            device-mapper-persistent-data \\\n                            lvm2\n\n#Remove any Old docker version\nsudo yum remove docker docker-common container-selinux docker-selinux docker-engine\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install docker","attrs":{"script":"#!\/bin\/bash\nset -ex\n\n# install docker engine\nsudo yum-config-manager --add-repo https:\/\/download.docker.com\/linux\/centos\/docker-ce.repo\nsudo yum install --quiet -y docker\n\nsudo systemctl start docker\nsudo systemctl enable docker\nsudo groupadd docker\nsudo usermod -aG docker $USER\n\n# install docker-compose\ncurl -s https:\/\/api.github.com\/repos\/docker\/compose\/releases\/latest \\\n  | grep browser_download_url \\\n  | grep docker-compose-Linux-x86_64 \\\n  | cut -d '\"' -f 4 \\\n  | wget -qi -\nchmod +x docker-compose-Linux-x86_64\nsudo mv docker-compose-Linux-x86_64 \/usr\/local\/bin\/docker-compose","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install custom login app","attrs":{"script":"#!\/bin\/bash\n\n# clone custom login repo\nsudo git clone https:\/\/github.com\/halsayed\/prism-custom-dashboard.git \/app\n\n# generate self-signed certificate for nginx\nsudo mkdir -p \/app\/nginx\/ssl\nsudo openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \\\n    -subj \"\/C=US\/ST=NewYork\/L=Springfield\/O=Dis\/CN=@@{address}@@\" \\\n    -keyout \/app\/nginx\/ssl\/nginx.key  -out \/app\/nginx\/ssl\/nginx.crt\n\n# update nginx default config\necho 'server {\n    listen 80;\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name localhost;\n\n    ssl_certificate \/etc\/nginx\/ssl\/nginx.crt;\n    ssl_certificate_key \/etc\/nginx\/ssl\/nginx.key;\n\n    ssl_protocols TLSv1.2 TLSv1.1 TLSv1;\n\n    access_log \/var\/log\/nginx\/access.log;\n    error_log \/var\/log\/nginx\/error.log;\n\n    location ~ ^\/$ {\n        if ($http_cookie !~* \"NTNX_IGW_SESSION\") {\n            return 301 https:\/\/$host\/login\/;\n        }\n        proxy_pass https:\/\/@@{PRISM_IP}@@:@@{PRISM_PORT}@@;\n    }\n\n    location \/ {\n        proxy_pass https:\/\/@@{PRISM_IP}@@:@@{PRISM_PORT}@@;\n    }\n\n    location \/login\/ {\n        proxy_pass http:\/\/login:5000\/;\n    }\n}' | sudo tee \/app\/nginx\/conf.d\/default.conf\n\n\n# update docker-compose file\necho 'version: \"3.0\"\nservices:\n  nginx:\n    build: .\/nginx\/.\n    restart: always\n    ports:\n      - \"443:443\"\n  login:\n    build: .\/login\/.\n    restart: always\n    environment:\n      - PRISM_IP=@@{PRISM_IP}@@\n      - PRISM_PORT=@@{PRISM_PORT}@@\n      - PRISM_REDIRECT=https:\/\/@@{address}@@\/console\/' | sudo tee \/app\/docker-compose.yml\n\n# start docker compose\ncd \/app\nsudo sudo \/usr\/local\/bin\/docker-compose up -d\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"NginxPackage___install___runbook","main_task_local_reference":{"kind":"app_task","name":"NginxPackage___install___dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Nginx"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_NginxPackage_action_uninstall","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_NginxPackage_action_uninstall","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_NginxPackage_action_uninstall"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"centos7","version":"","options":{"type":"","name":"centos7","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"https:\/\/cloud.centos.org\/centos\/7\/images\/CentOS-7-x86_64-GenericCloud.qcow2","version":{"product_version":"1.0","type":"","product_name":"centos7"},"architecture":"X86_64","type":""},"description":""},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"NginxDeployment","min_replicas":"1","default_replicas":"","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"NginxPackage"}],"substrate_local_reference":{"kind":"app_substrate","name":"NginxSubstrace"},"options":{"type":""},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"AHV","variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"PRISM_IP","value":"10.38.11.9","label":"Prism IP Address","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"PRISM_PORT","value":"9440","label":"Prism Port","attrs":{"type":""},"editables":{"value":true},"is_hidden":false}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS_CRED"},"type":"USER"},"name":"CustomLogin"},"api_version":"3.0","metadata":{"last_update_time":"1604229568748118","kind":"blueprint","spec_version":1,"creation_time":"1604229566680166","name":"CustomLogin"}}